<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Third Party Cookies Trouble With Chrome And AWS ALB - anhduc720</title><meta name="gridsome:hash" content="7229c0c1835f6cca35481b4542b9e5736b50b689"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="theme-color" content="#10c186"><meta data-vue-tag="ssr" name="google-site-verification" content="undefined"><meta data-vue-tag="ssr" name="apple-mobile-web-app-status-bar-style" content="default"><meta data-vue-tag="ssr" data-key="description" name="description" content="undefined"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.559c27a1344774b013969e7a1468d85b.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.559c27a1344774b013969e7a1468d85b.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.559c27a1344774b013969e7a1468d85b.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.559c27a1344774b013969e7a1468d85b.png"><link data-vue-tag="ssr" rel="manifest" href="/manifest.json"><link rel="preload" href="/assets/css/0.styles.cc6763f2.css" as="style"><link rel="preload" href="/assets/js/app.80d210bc.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--doc-vue.fe8e4aa2.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.e94e6a6b.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-me-vue.cc55a30a.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.f49600bb.js"><link rel="prefetch" href="/assets/js/page--src--templates--tag-vue.238e2d2d.js"><link rel="stylesheet" href="/assets/css/0.styles.cc6763f2.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="site" data-v-3b13e215><header class="header" data-v-57449993><a href="/" title="Back to home" class="logo active" data-v-595f1fa8 data-v-57449993><!----><div data-v-595f1fa8 data-v-595f1fa8><img alt="logo" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 2560 669' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-7036710eef043836d76d365abfd7f136'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-7036710eef043836d76d365abfd7f136)' width='2560' height='669' xlink:href='data:image/svg%2bxml%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAARCAYAAABtu6qMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE3UlEQVRYw92XW4iVVRTHz3du3z4KznHEZrTQTDg5MeSghUKJpjZNPmSQPfQo6MsEIvg0CkKFoiCUGhTeEA26waihXQgvo3lBnZBJSQ1xfFAqQSe0HKwc/2uf/zqzzvabGR98qQ9%2b7LUv37f3WnuttfeXSuGJD9WktATpSr3D1yP2vQDWgpj1tHkn9aifbDbry1wulyjbR9qtbMcP%2bdjFu45iOmyPO4oZ1reAXlAwYypGcI/QCKqAVXYoZULDPJTy9lHlocx0MJJyhHZV9mfQTnkqGEs5Yw0mC9HJRVaS%2bnS3wjEgovw42AtWUqlIx%2bq7LNMcvxAcQVsj6%2blwHeF8ZeUPFbNUosWdGdmHcjnrOZZPumNFaV/I%2bjXQZfornmAUiVRZlOlwV7kIaU/LOFXOGCfiu1%2bhfpxyxhjHfivD8hmM6QPNQbtfg84h36l4CBatyk9zR72Sl8ATQd9b7oTva2B9kfvJG%2bqbMBxUeSPH6pJRFCW6a%2bjKdlchfwz524HcPZhrBMb3oJwTGj7psUYoMb5vGOXTrj/%2bPwWXGSr6zlJ33hthh9QLP9T6kMmmMrpDE8EnYD9YYlxY%2byejvgvlCnAUtNlFS8n6JtRPg8/ANmsE861x4ADYAXrwzstsz7IcC3ahvVWMA74Dk1SRMeA3cA80Mvtnzckgp0I32Kkxb/LFqsLFWjHC%2b2qcXFOscdcCFoAG8C8YH8RljAVdRXkGrAK3ZQdN%2bKgBPkT9d7BM3Btlk35HXJnydnABtDIEZmkImJxzCvL3sg4bJqLEOcb3TFU%2biOsGd9L3v1nOF94gNjludue8J7TRCFHuuVgnrQWvgjtAdyVj3PsE5NUoZYf%2bAROMcjpmK%2boH2X4TzLfxTfkiWEPPEeVmG29SI%2b1kPpHnFmQfJqnChdpKckMyzOtOmuze6g57A4zXk8GWlI%2b5s94IzWZRjaAbtIO7anEmIE1wP6LvPZQN4G/ITyUYYBtdNg/5VmgAKvQrvWgY6MW4ucYD9DtfADlRhnNM2QDuiFeuE4ywO2/if58cgcYw4cnxBhPkQfkGNFMXXw26KN/GhC3GA9QAnTRACdxVAzBjWw8QA0DM/YHytcAAkleucL4sjT0nNADkLyHv4Zg7FQNg0Qtcl9%2b9w2Z3VfkCuA42WqO4/tNhljvllZc7wnC/4NkuzwnXgvNgeng0GQ/oYgiUGN%2bVEDBhsp0JTt7rtR5glJP%2b3eDZhByghtrKZPsix8y0t8HFjOP24JY4xXV6BeeZhKjGaYJBpO8qqGP%2byOAU0EXNEFcTy4PLYIPurjkFJAl%2bDt6ley8JsncdkDxxEryNMTdQbjRXXlWuWeIafM2wW29OHZ3vJa5HTp5L4IPwBtjGfPCRMcByHo91gWdMAD3gTzDR3hka%2b7bY214JFEm9PXtRDmPyGy2KQq4Ho4LLUh6MoSFkXD14LLgi61H4NG%2bOVXMFt88SE3ONjinf45G5Ka8rdHsjLGNdwuJ0YKgM%2bMUd97s/xYaEPwbzuaqFDXoBGaRvsAtMwn9CNNQcSXPGcVzZaZvR14HnZUfBX%2bAddW8kPusZr5eV7lc%2buAprLEdKqKBejHjuRwNcl3VMlTzAtfqBuYYaU/UrrGc766/wv2CGif/EHyh7Ovwnnyoj8C4g93/%2b8NQE579XHOP%2bF8rfB8rMg9zyj6XAAAAAAElFTkSuQmCC' /%3e%3c/svg%3e" width="2560" data-src="/assets/static/logo-dark.42db587.08b82fc9486f721bb5058dbc06db0c39.svg" data-srcset="/assets/static/logo-dark.82a2fbd.08b82fc9486f721bb5058dbc06db0c39.svg 480w, /assets/static/logo-dark.cbab2cf.08b82fc9486f721bb5058dbc06db0c39.svg 1024w, /assets/static/logo-dark.2665e34.08b82fc9486f721bb5058dbc06db0c39.svg 1920w, /assets/static/logo-dark.42db587.08b82fc9486f721bb5058dbc06db0c39.svg 2560w" data-sizes="(max-width: 2560px) 100vw, 2560px" class="g-image g-image--lazy g-image--loading" data-v-595f1fa8><noscript data-v-595f1fa8><img src="/assets/static/logo-dark.42db587.08b82fc9486f721bb5058dbc06db0c39.svg" class="g-image g-image--loaded" width="2560" alt="logo"></noscript></div></a><nav class="nav" data-v-57449993><button id="themeSwitch" aria-label="Switch theme between light and dark" data-v-1097eb34 data-v-57449993><!----><!----></button><button aria-label="Toggle the sidebar" class="toggle" data-v-def1a688 data-v-57449993><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="open feather feather-menu" data-v-def1a688 data-v-def1a688><line x1="3" y1="12" x2="21" y2="12" data-v-def1a688></line><line x1="3" y1="6" x2="21" y2="6" data-v-def1a688></line><line x1="3" y1="18" x2="21" y2="18" data-v-def1a688></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close feather feather-x" style="display:none;" data-v-def1a688 data-v-def1a688><line x1="18" y1="6" x2="6" y2="18" data-v-def1a688></line><line x1="6" y1="6" x2="18" y2="18" data-v-def1a688></line></svg></button></nav></header><aside class="sidebar" data-v-fabd13e2><nav data-v-fabd13e2><ul data-v-fabd13e2><li class="section" data-v-fabd13e2><h3 class="section-title" data-v-fabd13e2>Introduction</h3><ul data-v-fabd13e2><li data-v-fabd13e2><a href="/about-me" class="topic" data-v-fabd13e2>About me</a></li></ul></li><li class="section" data-v-fabd13e2><h3 class="section-title" data-v-fabd13e2>Content</h3><ul data-v-fabd13e2><li data-v-fabd13e2><a href="/blogs/third-party-cookies-trouble/#the-bug" class="sub-topic" data-v-fabd13e2>The Bug</a></li><li data-v-fabd13e2><a href="/blogs/third-party-cookies-trouble/#first-step-is-reproduce-the-bug" class="sub-topic" data-v-fabd13e2>First step is reproduce the bug</a></li><li data-v-fabd13e2><a href="/blogs/third-party-cookies-trouble/#more-detail" class="sub-topic" data-v-fabd13e2>More Detail</a></li><li data-v-fabd13e2><a href="/blogs/third-party-cookies-trouble/#something-else" class="sub-topic" data-v-fabd13e2>Something else</a></li><li data-v-fabd13e2><a href="/blogs/third-party-cookies-trouble/#fix" class="sub-topic" data-v-fabd13e2>Fix</a></li><li data-v-fabd13e2><a href="/blogs/third-party-cookies-trouble/#lesson" class="sub-topic" data-v-fabd13e2>Lesson</a></li></ul></li></ul><a href="https://github.com/anhduc720" title="Git-repository" aria-label="anhduc720 on Github" class="git small" data-v-4b3d94ee data-v-fabd13e2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-github" data-v-4b3d94ee data-v-4b3d94ee><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-4b3d94ee data-v-4b3d94ee></path></svg>
  Fork me on Github
</a></nav></aside><main class="main"><h1 data-v-3b13e215>
    Third Party Cookies Trouble With Chrome And AWS ALB
  </h1><div class="markdown" data-v-3b13e215><h2 id="the-bug"><a href="#the-bug" aria-hidden="true"><span class="icon icon-link"></span></a>The Bug</h2>
<p>I have worked with a system that allows the client to create contact forms and embed them on a customer's site.</p>
<p>One day, I received a bug report. Client said that customer site can not display their form because the X-FRAME-OPTIONS error. And the story begins here</p>
<p>I think this is a individual error and the reason is that the client page does not allow our iframes to be displayed, So I said them to tell the customer to set the CSP header without having any more investigation.</p>
<p>But, the thing is not simple, our client reported again that the site still can not be displayed.
And I must start to investigate</p>
<h2 id="first-step-is-reproduce-the-bug"><a href="#first-step-is-reproduce-the-bug" aria-hidden="true"><span class="icon icon-link"></span></a>First step is reproduce the bug</h2>
<p>I have test with firefox, no error, test with safari, no error. And then is chrome, bravo. the error is here. The from still display but when end-user click on submit button. This frame display error "refuse connect to xxxxx". And the devtool display X-FRAME-OPTIONS error. </p>
<h2 id="more-detail"><a href="#more-detail" aria-hidden="true"><span class="icon icon-link"></span></a>More Detail</h2>
<p>So, I know that is not problem with frame options header or csp header. Of course customer's site refuse to display our form due to X-FRAME-OPTIONS in our site. But its just because the post request to our system return 500 error. And the error page do not have X-FRAME-OPTIONS to display in a iframe.</p>
<p>Then I read the log about this 500 Request. And I realized that the web server cannot verify the CSRFT token.
The request have CSRF Token here, why it can not be verified ?</p>
<p>The cookies, yes, when looking the request again, I see no session cookies is send with the request.</p>
<p>And with few searching, I know that because chrome change it's behavior, cookies without SameSite properties will be dafault to SameSite:Lax, which prevent chrome to using this cookies when the form is inside an iframe.</p>
<h2 id="something-else"><a href="#something-else" aria-hidden="true"><span class="icon icon-link"></span></a>Something else</h2>
<p>But, Chrome have changed this two years ago. Why we only have bug from now, Not one week or one year ago ?</p>
<p>Go deeper in system source code. I see that there is already have a fix in three years ago. This fix will skip CSRFT token verify when have no any cookies attached in the request.
And reason of that fix is because of safari on OSX and iOS. Safari default block all third party cookies. So the client and the previous Dev of this system decided to skip CSRFT verify in case no have any cookies. This is a quick fix and leave a security hole in the system but people is OK with it.</p>
<p>And this fix makes form functionality work when Chrome changes its policy in 2020.
Well, some wrong makes right, I don't know</p>
<p>Unfortunately, as the number of users increases, I have decided to add more server and turn on stickiness session on ALB to keep user interact with the same server each time.
And now the bug happen. With stickiness session on, we have additional two cookies. These cookies have "SameSite=None; Secured". So, Chrome feel free to put it on POST request form. And make the previous fix invalid because the cookies is not blank now.</p>
<p>So. This is our Bug</p>
<h2 id="fix"><a href="#fix" aria-hidden="true"><span class="icon icon-link"></span></a>Fix</h2>
<p>When have clearly info about this Bug. Everything is simple. with some setting and a custom middleware ( Our system was written by rails 5). The bug is gone.</p>
<h2 id="lesson"><a href="#lesson" aria-hidden="true"><span class="icon icon-link"></span></a>Lesson</h2>
<p>Be careful with the old classical system. A light touch can knock them down. Everything must be test carefully.</p>
</div></main></div>
    <script>window.__INITIAL_STATE__={"data":{"doc":{"title":"Third Party Cookies Trouble With Chrome And AWS ALB","path":"\u002Fblogs\u002Fthird-party-cookies-trouble\u002F","slug":"third-party-cookies-trouble","date":"28. June 2022","timeToRead":3,"content":"\u003Ch2 id=\"the-bug\"\u003E\u003Ca href=\"#the-bug\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EThe Bug\u003C\u002Fh2\u003E\n\u003Cp\u003EI have worked with a system that allows the client to create contact forms and embed them on a customer's site.\u003C\u002Fp\u003E\n\u003Cp\u003EOne day, I received a bug report. Client said that customer site can not display their form because the X-FRAME-OPTIONS error. And the story begins here\u003C\u002Fp\u003E\n\u003Cp\u003EI think this is a individual error and the reason is that the client page does not allow our iframes to be displayed, So I said them to tell the customer to set the CSP header without having any more investigation.\u003C\u002Fp\u003E\n\u003Cp\u003EBut, the thing is not simple, our client reported again that the site still can not be displayed.\nAnd I must start to investigate\u003C\u002Fp\u003E\n\u003Ch2 id=\"first-step-is-reproduce-the-bug\"\u003E\u003Ca href=\"#first-step-is-reproduce-the-bug\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EFirst step is reproduce the bug\u003C\u002Fh2\u003E\n\u003Cp\u003EI have test with firefox, no error, test with safari, no error. And then is chrome, bravo. the error is here. The from still display but when end-user click on submit button. This frame display error \"refuse connect to xxxxx\". And the devtool display X-FRAME-OPTIONS error. \u003C\u002Fp\u003E\n\u003Ch2 id=\"more-detail\"\u003E\u003Ca href=\"#more-detail\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EMore Detail\u003C\u002Fh2\u003E\n\u003Cp\u003ESo, I know that is not problem with frame options header or csp header. Of course customer's site refuse to display our form due to X-FRAME-OPTIONS in our site. But its just because the post request to our system return 500 error. And the error page do not have X-FRAME-OPTIONS to display in a iframe.\u003C\u002Fp\u003E\n\u003Cp\u003EThen I read the log about this 500 Request. And I realized that the web server cannot verify the CSRFT token.\nThe request have CSRF Token here, why it can not be verified ?\u003C\u002Fp\u003E\n\u003Cp\u003EThe cookies, yes, when looking the request again, I see no session cookies is send with the request.\u003C\u002Fp\u003E\n\u003Cp\u003EAnd with few searching, I know that because chrome change it's behavior, cookies without SameSite properties will be dafault to SameSite:Lax, which prevent chrome to using this cookies when the form is inside an iframe.\u003C\u002Fp\u003E\n\u003Ch2 id=\"something-else\"\u003E\u003Ca href=\"#something-else\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ESomething else\u003C\u002Fh2\u003E\n\u003Cp\u003EBut, Chrome have changed this two years ago. Why we only have bug from now, Not one week or one year ago ?\u003C\u002Fp\u003E\n\u003Cp\u003EGo deeper in system source code. I see that there is already have a fix in three years ago. This fix will skip CSRFT token verify when have no any cookies attached in the request.\nAnd reason of that fix is because of safari on OSX and iOS. Safari default block all third party cookies. So the client and the previous Dev of this system decided to skip CSRFT verify in case no have any cookies. This is a quick fix and leave a security hole in the system but people is OK with it.\u003C\u002Fp\u003E\n\u003Cp\u003EAnd this fix makes form functionality work when Chrome changes its policy in 2020.\nWell, some wrong makes right, I don't know\u003C\u002Fp\u003E\n\u003Cp\u003EUnfortunately, as the number of users increases, I have decided to add more server and turn on stickiness session on ALB to keep user interact with the same server each time.\nAnd now the bug happen. With stickiness session on, we have additional two cookies. These cookies have \"SameSite=None; Secured\". So, Chrome feel free to put it on POST request form. And make the previous fix invalid because the cookies is not blank now.\u003C\u002Fp\u003E\n\u003Cp\u003ESo. This is our Bug\u003C\u002Fp\u003E\n\u003Ch2 id=\"fix\"\u003E\u003Ca href=\"#fix\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EFix\u003C\u002Fh2\u003E\n\u003Cp\u003EWhen have clearly info about this Bug. Everything is simple. with some setting and a custom middleware ( Our system was written by rails 5). The bug is gone.\u003C\u002Fp\u003E\n\u003Ch2 id=\"lesson\"\u003E\u003Ca href=\"#lesson\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ELesson\u003C\u002Fh2\u003E\n\u003Cp\u003EBe careful with the old classical system. A light touch can knock them down. Everything must be test carefully.\u003C\u002Fp\u003E\n","headings":[{"value":"The Bug","anchor":"#the-bug"},{"value":"First step is reproduce the bug","anchor":"#first-step-is-reproduce-the-bug"},{"value":"More Detail","anchor":"#more-detail"},{"value":"Something else","anchor":"#something-else"},{"value":"Fix","anchor":"#fix"},{"value":"Lesson","anchor":"#lesson"}]}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.80d210bc.js" defer></script><script src="/assets/js/page--src--templates--doc-vue.fe8e4aa2.js" defer></script>
  </body>
</html>
